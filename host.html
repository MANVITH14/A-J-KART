<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Host Dashboard - A J KART</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="site-header">
  <div class="left"><div class="brand">A J KART</div><div class="tagline">Host Dashboard</div></div>
    <div class="right"><button id="logout">Logout</button></div>
  </header>
  <main style="padding:20px;">
    <h2>Orders</h2>
    <div style="margin-bottom:12px;"><button id="exportCsv" class="primary">Export CSV</button></div>
    <div id="ordersList">Loading...</div>
  </main>
  <script>
    function toCSV(rows){
      const esc = v => '"' + String(v||'').replace(/"/g,'""') + '"';
      const headers = ['orderId','createdAt','amount','items','address'];
      const lines = [headers.join(',')];
      rows.forEach(r=>{
        const items = r.cart.map(i=>`${i.name} (x${i.qty})`).join('|');
        const addr = r.address? `${r.address.name}; ${r.address.line1}; ${r.address.city}; ${r.address.state}; ${r.address.pincode}` : '';
        lines.push([esc(r.id), esc(r.createdAt), esc(r.amount), esc(items), esc(addr)].join(','));
      });
      return lines.join('\n');
    }

    async function loadOrders(){
      const token = localStorage.getItem('flipkart_token');
      if(!token) return window.location='/login.html';
      const res = await fetch('/api/orders',{headers:{'Authorization':'Bearer '+token}});
      if(res.status===403){ alert('Access denied'); return window.location='/login.html'; }
      const list = await res.json();
      const el = document.getElementById('ordersList');
      if(!list || list.length===0) el.innerHTML = '<p>No orders yet</p>';
      else {
        el.innerHTML = list.map(o=>{
          const items = o.cart.map(i=>`<li>${i.name} — ₹${i.price} x ${i.qty}</li>`).join('');
          const addr = o.address? `<div style="margin-top:8px"><strong>Address</strong><div>${o.address.name}</div><div>${o.address.line1}</div><div>${o.address.city}, ${o.address.state} - ${o.address.pincode}</div></div>` : '';
          return `<div style="border:1px solid #eee;padding:12px;border-radius:6px;margin-bottom:8px;"><div style="display:flex;justify-content:space-between"><div style="font-weight:700">Order ${o.id}</div><div>${o.createdAt}</div></div><div>Amount: ₹${o.amount}</div><div>Items (${o.cart.length}):<ul>${items}</ul></div>${addr}<div style="margin-top:8px;color:#666">Status: ${o.status}</div></div>`;
        }).join('');
      }

      document.getElementById('exportCsv').addEventListener('click', ()=>{
        const csv = toCSV(list);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'orders.csv'; a.click(); URL.revokeObjectURL(url);
      });
    }
    document.getElementById('logout').addEventListener('click', ()=>{ localStorage.removeItem('flipkart_token'); localStorage.removeItem('flipkart_role'); window.location='/'; });
    loadOrders();
  </script>
</body>
</html>